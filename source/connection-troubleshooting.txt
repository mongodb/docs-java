.. _java-connection-troubleshooting:

.. sharedinclude:: dbx/connection-troubleshooting.rst

   .. replacement:: non-connection-issue-list

      - The :ref:`Frequently Asked Questions (FAQ) <java-faq>` for the Java driver
      - The :ref:`Issues & Help <java-issues-and-help>` topic for information about
        reporting bugs, contributing to the driver, and additional resources
      - The `MongoDB Community Forums <{+communityForums+}`__ for
        questions, discussions, or general technical support

   .. replacement:: server-selection-timeout-error


      .. code-block:: none
         :copyable: false

         Error: couldn't connect to server 127.0.0.1:27017

   .. replacement:: check-connection-string-anchor

      .. _java-connection-string-port:

   .. replacement:: multiple-hosts-connection-gudie-link

      To learn how to specify multiple replica set hosts,
      see :ref:`Connect to a Replica set <connect-replica-set>`

   .. replacement:: configure-firewall-anchor

      .. _java-connection-firewall:

   .. replacement:: authentication-error-anchor

      .. _java-authentication-error:

  .. replacement:: scram-failure-error

     .. code-block:: none
        :copyable: false

        Command failed with error 18 (AuthenticationFailed): 'Authentication failed.' on server localhost:27017.

  .. replacement:: check-credentials-formatting-anchor

     .. _java-connection-string-auth:

  .. replacement:: learn-more-connection-string-admonition

     .. note::

        For more information about using connection strings with the Java driver,
        see :ref:`Connection URI <connection-uri>` in the Connection Guide.


  .. replacement:: verify-authentication-database-anchor

     .. _java-verify-auth-db:

  .. replacement:: authsource-param-code-block

     TODO

  .. replacement:: authentication-guide-reference

     TODO

  .. replacement:: verify-authentication-mechanism-anchor

     .. _java-verify-auth-mechanism:

  .. replacement:: authsource-param-code-block

     .. code-block:: java
        :copyable: false

        MongoClient mongoClient = MongoClients.create("mongodb://<username>:<password>@<hostname>:<port>/?authSource=users");

  .. replacement:: dns-resolution-anchor

     .. _java-dns-resolution-error:

  .. replacement:: dns-error-message

     .. code-block:: none
        :copyable: false

        com.mongodb.MongoSocketWriteException: Exception sending message

  .. replacement:: check-the-number-of-connections-anchor

     .. _java-connection-number-connections:

  .. replacement:: mongo-client-class
  
     ``MongoClient``

  .. replacement:: max-pool-size-param

     ``maxPoolSize``

  .. replacement:: max-pool-size-default

     ``100``

  .. replacement:: max-idle-time-param

     ``maxIdleTimeMS``

  .. replacement:: connection-pools-learn-more

     TODO

  .. replacement:: authentication-error-anchor

     TODO

  .. replacement:: scram-failure-error

     TODO

  .. replacement:: check-credential-formatting-anchor

     TODO


.. _java-connection-certificate:

Install Security Certificates
-----------------------------

If you are using Java version 8 or earlier, you might need to manually add a
certificate to your trust store. You can either upgrade to a later version of
the JDK or read the :atlas:`Security FAQ </reference/faq/security/#java-users>`
instructions in the Atlas documentation for information on how to add the
certificate.

Timeout Error
~~~~~~~~~~~~~

Sometimes when you send messages through the driver to the server, the messages
take a while to respond. When this happens, you might receive an error message
similar to one of the following error messages:

.. code-block:: none
   :copyable: false

   Timed out after 30000 ms while waiting for a server that matches ReadPreferenceServerSelector{readPreference=primary}.

.. code-block:: none
   :copyable: false

   No server chosen by ReadPreferenceServerSelector{readPreference=primary} from cluster description

If you receive one of these errors, try the following methods to resolve the
issue.

Set ``maxConnectionTimeoutMS``
------------------------------

The ``maxConnectionTimeoutMS`` option indicates the amount of time the Java
driver waits for a connection
before timing out. The default value is ``10000``. You can increase this value
or set it to ``0`` if you want the driver to never timeout.

Set ``maxConnectionLifeTime`` and ``maxConnectionIdleTime``
-----------------------------------------------------------

Consider setting ``maxConnectionLifeTime`` and
``maxConnectionIdleTime``. These parameters configure how long a connection
can be maintained with a MongoDB instance. For more information about these
parameters, see :ref:`Connection Pool Settings <mcs-connectionpool-settings>`.

Check the Number of Connections
-------------------------------

You might have too many open connections. The solution to this is described
under :ref:`Error Sending Message <java-connection-number-connections>`.

Install Certificate
-------------------

If you are using an older version of Java, you might need to manually install
some certificates as described under
:ref:`Error Sending Message <java-connection-certificate>`.

Miscellaneous Errors
~~~~~~~~~~~~~~~~~~~~

This section shows connection errors that do not fall into a broader category.
Each section lists the error message and then the specific steps you should
take to resolve it.

Monitor Thread Exception
------------------------

.. code-block:: none
   :copyable: false

   INFO: Exception in monitor thread while connecting to server ssc-cluster-01-shard-00-02.9cbnp.mongodb.net:27017

To resolve this error, you must manually install certificates as described
under :ref:`Error Sending Message <java-connection-certificate>`.

Certificate Request Exception
-----------------------------

.. code-block:: none
   :copyable: false

   javax.net.ssl.SSLHandshakeException: extension (5) should not be presented in certificate_request

This is a `known error <https://bugs.openjdk.java.net/browse/JDK-8236039>`__
that can occur when using the TLS 1.3 protocol with specific versions of the
JDK. If you encounter this error when connecting to your MongoDB instance or
cluster, update your JDK to one of the following patch versions or newer:

- JDK 11.0.7
- JDK 13.0.3
- JDK 14.0.2

Additional Tips
~~~~~~~~~~~~~~~

While not related to a specific error message, this section includes
additional information that can be useful when attempting to troubleshoot
connection issues.

Get Log Information for TLS/SSL
-------------------------------

When using TLS/SSL, you can use the ``-Djavax.net.debug=all`` system property
to view additional log statements. This can help when attempting to debug any
connection issues. See `the Oracle guide to debugging TLS/SSL connections
<https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/ReadDebug.html>`__
for more information.
