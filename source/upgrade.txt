.. _java-upgrade-driver:

=======================
Upgrade Driver Versions
=======================

.. facet::
   :name: genre
   :values: reference

.. meta::
   :keywords: java sync, backwards compatibility, update

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Overview
--------

In this section, you can identify the changes you need to make to your
application to upgrade your driver to a new version.

Before you upgrade, perform the following actions:

- Ensure the new version is compatible with the {+mdb-server+} versions
  your application connects to and the Java Runtime Environment (JRE) your
  application runs on. See the :ref:`Java Compatibility <java-compatibility-tables>`
  page for this information.
- Address any breaking changes between the current version of the driver
  your application is using and your planned upgrade version in the
  :ref:`Breaking Changes <java-breaking-changes>` section. To learn
  more about the {+mdb-server+} release compatibility changes, see the
  :ref:`<java-server-release-changes>` section.

.. tip::

   To minimize the amount of changes your application may require when
   upgrading driver versions in the future, use the
   :ref:`{+stable-api+} <stable-api-java>`.

.. _java-breaking-changes:

Breaking Changes
----------------

A breaking change is a modification in a convention or behavior in
a specific version of the driver that may prevent your application from
working properly if not addressed before upgrading.

The breaking changes in this section are categorized by the driver version that
introduced them. When upgrading driver versions, address all the breaking
changes between the current and upgrade versions. For example, if you
are upgrading the driver from v4.0 to v4.5, address all breaking changes from
the version after v4.0 including any listed under v4.5.

.. _java-breaking-changes-v5.0:

Version 5.0 Breaking Changes
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

- This driver version introduces the following changes to the ``ConnectionId`` class:
  
  - The ``ConnectionId`` constructor now accepts a value of type ``long`` as its second
    parameter instead of type ``int``. Similarly, the constructor now accepts a value of
    type ``Long`` as its third parameter instead of type ``Integer``. Because this change breaks
    binary compatibility, recompile any existing code that calls the ``ConnectionId`` constructor.

  - The ``withServerValue()`` method now accepts a parameter of type ``long`` rather than
    type ``int``. This change breaks binary compatibility, so you must recompile any code
    that calls the ``withServerValue()`` method.

  - The ``getServerValue()`` method now returns a value of type ``Long`` instead of type
    ``Integer``. Similarly, the ``getLocalValue()`` method returns a value of type
    ``long`` instead of type ``int``. Because this change breaks both binary and source
    compatibility, update any source code that uses these methods and rebuild your binary.

- This driver version removes the following record annotations:
  
  - ``BsonId``
  - ``BsonProperty``
  - ``BsonRepresentation``

- You must pass a timeout duration, which is the first parameter, to the
  following ``SocketSettings`` builder methods as a ``long`` type:

  - ``connectTimeout()``
  - ``readTimeout()``

  In earlier versions, this parameter is of type ``int`` for both methods. To view an example
  that shows how to instantiate a ``SocketSettings`` instance by using
  these methods, see the :ref:`SocketSettings Example
  <java-socketsettings-example>` in the Specify MongoClient Settings
  guide.

- This driver version removes the ``Filters.eqFull()`` method, which allowed you
  to construct an equality filter when performing a vector search.
  You can use the ``Filters.eq()`` method when instantiating a
  ``VectorSearchOptions`` type, as shown in the following code:

  .. code-block:: java
     
     VectorSearchOptions opts = vectorSearchOptions().filter(eq("x", 8));

.. _java-breaking-changes-v5.0-observables:

- This driver version removes the
  ``org.mongodb.scala.ObservableImplicits.ToSingleObservableVoid`` implicit
  class. This means the ``org.reactivestreams.Publisher[Void]`` type no longer
  converts automatically to ``org.mongodb.scala.SingleObservable[Void]``. The also
  API exposes ``org.mongodb.scala.Observable[Unit]`` instead of
  ``org.mongodb.scala.Observable[Void]``. 
  
  .. After the 5.0 Scala API docs are released, this line will be uncommented. 
    For more information, see the `Observable trait documentation <https://mongodb.github.io/mongo-java-driver/5.0/apidocs/mongo-scala-driver/org/mongodb/scala/Observable.html>`__.

.. _java-breaking-changes-v4.8:

Version 4.8 Breaking Changes
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

- The driver ends support for connecting to {+mdb-server+} versions v3.4 and
  earlier. To learn more about this change, see the :ref:`<java-server-release-change-v4.8>`
  section.
- You must add an explicit dependency on the ``org.bson.codecs.record``
  module if your application deploys the driver in an OSGi container and
  relies on the driver for encoding and decoding Java records.

- The ``RecordCodec``, implemented in v4.6, deserialized POJOs and record
  classes that are specified as type parameters of ``List`` or ``Map`` fields
  of a record as ``Document`` values instead of their respective classes. This
  version now deserializes them to the proper record and POJO types.

  For example, the following record class definitions show a ``Book`` record
  that contains a ``List`` that receives a ``Chapter`` type parameter:

  .. code-block:: java

     public record Book(String title, List<Chapter> chapters) {}
     public record Chapter(Integer number, String text) {}

  Starting in this version, the codec deserializes data in the ``List`` into
  ``Chapter`` record classes instead of ``Document`` values.

.. _java-breaking-changes-v4.7:

Version 4.7 Breaking Changes
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

- The ``setWindowFields`` builder API is no longer beta. The new builder
  breaks binary and source compatibility. See the
  `Aggregates API documentation <https://mongodb.github.io/mongo-java-driver/4.7/apidocs/mongodb-driver-core/com/mongodb/client/model/Aggregates.html>`__
  for information the new ``setWindowFields()`` method signatures.

  If your application uses this builder in a version prior to v4.7, update
  your source code to use the new method signature and rebuild your binary.

.. _java-breaking-changes-v4.2:

Version 4.2 Breaking Changes
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

- The ``ObjectId`` class and its ``serialVersionUID`` field were updated
  to use a new format that minimizes serialization compatibility issues
  across different versions of the driver.

  If an application using this version or later of the driver attempts to
  perform Java Object Serialization on any objects that contain an
  ``ObjectId`` and were serialized by a prior version of the driver, Java
  throws an ``InvalidClassException``.

  To learn more about Java Object Serialization, see the Java
  Documentation on `Serializable Objects <https://docs.oracle.com/javase/tutorial/jndi/objects/serial.html>`__.

.. _java-breaking-changes-v4.0:

Version 4.0 Breaking Changes
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

- Several classes and methods marked as deprecated in the 3.12 release
  were removed in this version.
- The insert helper methods return an insert result object instead of
  ``void``.
- The ``toJson()`` methods on ``BsonDocument``, ``Document``, and
  ``DbObject`` return a relaxed JSON format instead of a strict JSON
  format. This makes the JSON documents more readable, but can make it more
  difficult to identify the BSON type information, such as the difference
  between a 32-bit and 64-bit integer. If your application relies on the
  strict JSON format, use the strict mode when reading or writing data.
  Learn how to specify the JSON format in the current API in the
  :ref:`Document Data Format: Extended JSON <java-extended-json>` guide.
- The default BSON representation of ``java.util.UUID`` value was changed
  from ``JAVA_LEGACY`` to ``UNSPECIFIED``. Applications that store or retrieve
  UUID values must explicitly specify which representation to use. You can
  specify the representation in the ``uuidRepresentation`` property of
  ``MongoClientSettings``.

  The UUID representation that you specify strictly controls how the driver
  decodes UUIDs. In previous versions of the driver, if you specified the
  ``JAVA_LEGACY`` representation, the driver would decode binary objects
  of subtypes 3 and 4 as UUIDs. In version 4.0, the ``JAVA_LEGACY``
  representation works only with subtype 3.

  For a list of members in the ``UuidRepresentation`` enum, see the
  `v4.0 API documentation <https://mongodb.github.io/mongo-java-driver/4.0/apidocs/bson/org/bson/UuidRepresentation.html>`__.

- The connection pool no longer restricts the number of wait queue threads
  or asynchronous tasks that require a connection to MongoDB. The
  application should throttle requests as necessary rather than depend on
  the driver to throw a ``MongoWaitQueueFullException``.
- The driver no longer logs using the ``java.util.logging`` (JUL) package
  and only supports the SLF4J logging framework.
- The embedded and Android drivers were removed. If your application
  relies on these drivers, you must continue to use a 3.x Java driver
  version.
- The uber JARs, ``mongo-java-driver`` and ``mongodb-driver``, are no
  longer published. If your application relies on one of these, you must
  switch to either ``mongodb-driver-sync`` or ``mongodb-driver-legacy``
  depending on which API the application uses. Make sure you remove the
  uber JARs from your dependencies.
- Updates to several classes introduced binary compatibility breaks, such
  as the method signature change to the insert helper methods. Recompile
  any classes that link to the driver against this version or later to ensure
  that they continue to work.

.. _java-server-release-changes:

Server Release Compatibility Changes
------------------------------------

A server release compatibility change is a modification
to the {+driver-long+} that discontinues support for a set of
{+mdb-server+} versions.

The driver discontinues support for a {+mdb-server+} version after it reaches
end-of-life (EOL).

To learn more about the MongoDB support for EOL products,
see the `Legacy Support Policy <https://www.mongodb.com/support-policy/legacy>`__.

.. _java-server-release-change-v4.8:

Version 4.8 Server Release Support Changes
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

- The v4.8 driver drops support for {+mdb-server+} v3.4 and earlier.
  To use the v4.8 driver, your {+mdb-server+} must be v3.6 or later. To learn
  how to upgrade your {+mdb-server+} to v3.6, follow the link that corresponds
  to your MongoDB deployment configuration:

  - :ref:`<3.6-upgrade-replica-set>`
  - :ref:`<3.6-upgrade-standalone>`
  - :ref:`<3.6-upgrade-sharded-cluster>`
