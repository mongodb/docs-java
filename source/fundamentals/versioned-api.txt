=============
Versioned API
=============

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. note::

   The Versioned API feature requires MongoDB Server 5.0 or later. You
   should only use the Versioned API feature if you are connecting to
   MongoDB servers that are upgraded to a version that supports this feature.

This guide shows you how to specify the **Versioned API** when connecting to
a MongoDB instance or replica set. You can use the Versioned API feature to
force the server to run operations with consistent behavior as specified by
an **API version**. An API version defines expected behavior of operations
such as the information expected in the request and the response.

When you use the Versioned API feature, you can update your MongoDB driver or
server without worrying about backward compatibility issues of the commands
covered by the Versioned API.

..
   TODO: See the server manual page on `Versioned API <https://docs.mongodb.com/v5.0/reference/versioned-api/>`__
   for more information including the set the commands covered.

The following sections describe how you can enable Versioned API for
your MongoDB client and each of the options that you can specify.

Enable Versioned API on a MongoDB Client
----------------------------------------

To enable the Versioned API, you must specify an API version in the settings
that you use to create your MongoDB client. Once you instantiate a
``MongoClient`` instance with a specified Versioned API, all commands you
run with that client use that version of the Versioned API. If you need to
run commands not covered by the Versioned API or with a different version of
it, instantiate a separate client.

The example below shows how you can instantiate a ``MongoClient`` that
specifies version "1" of the Versioned API and connects to a server by
performing the following operations:

- Construct a ``ServerApi`` instance using the ``ServerApi.Builder``
  helper class.
- Construct a ``MongoClientSettings`` instance using the
  ``MongoClientSettings.Builder`` class.
- Specify a server to connect to using a ``ServerAddress`` instance.
- Instantiate a ``MongoClient`` using the ``MongoClients.create()`` method
  and pass your ``MongoClientSettings`` instance as a parameter.

.. literalinclude:: /includes/fundamentals/code-snippets/VersionedApiExample.java
   :start-after: start serverAPIVersion
   :end-before: end serverAPIVersion
   :language: java
   :dedent:

.. warning::

   Make sure that when you specify an API version that you connect to a
   version of MongoDB server that supports Versioned API. Otherwise, your
   application may raise an exception when attempting to perform any operation
   that sends a command to MongoDB. For example, a query to a server could
   return an exception message that resembles the following:

   .. code-block:: none
      :copyable: false

      com.mongodb.MongoQueryException: Query failed with error code 9 and error message 'Failed to parse: {...} Unrecognized field 'apiVersion'.' on server

For more information on the methods and classes referenced in this
section, see the following API documentation:

- :java-docs:`ServerApi <apidocs/mongodb-driver-core/com/mongodb/ServerApi.html>`
- :java-docs:`ServerApi.Builder <apidocs/mongodb-driver-core/com/mongodb/ServerApi.Builder.html>`
- :java-docs:`ServerAddress <apidocs/mongodb-driver-core/com/mongodb/ServerAddress.html>`
- :java-docs:`MongoClientSettings <apidocs/mongodb-driver-core/com/mongodb/MongoClientSettings.html>`
- :java-docs:`MongoClientSettings.Builder <apidocs/mongodb-driver-core/com/mongodb/MongoClientSettings.Builder.html>`
- :java-docs:`MongoClients.create() <apidocs/mongodb-driver-sync/com/mongodb/client/MongoClients.html#create(com.mongodb.MongoClientSettings)>`
- :java-docs:`MongoClient <apidocs/mongodb-driver-sync/com/mongodb/client/MongoClient.html>`

Additional Options
------------------

You can set additional options to enable or disable behavior related to
Versioned API as described in the following table.

.. list-table::
   :header-rows: 1
   :stub-columns: 1
   :widths: 25,75

   * - Option Name
     - Description

   * - Strict
     - | **Optional**. When set, if you call a command that is not part of declared API version, the driver raises an exception.
       |
       | Default: **false**
       | For more information, see the :java-docs:`strict() <apidocs/mongodb-driver-core/com/mongodb/ServerApi.Builder.html#strict(boolean)>` API documentation.

   * -  DeprecationErrors
     - | **Optional**. When set, if you call a command that is deprecated in the declared API version, the driver raises an exception.
       |
       | Default: **false**
       | For more information, see the :java-docs:`deprecationErrors() <apidocs/mongodb-driver-core/com/mongodb/ServerApi.Builder.html#>` API documentation.


The following code example shows how you can set the two options on an
instance of ``ServerApi`` by chaining methods to specify the options to the
``ServerApi.Builder``:

.. literalinclude:: /includes/fundamentals/code-snippets/VersionedApiExample.java
   :start-after: start apiVersionOptions
   :end-before: end apiVersionOptions
   :language: java
   :dedent:

